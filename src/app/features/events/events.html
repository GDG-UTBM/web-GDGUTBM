<div class="events-page">
  <section class="page-banner">
    <div class="container-custom page-banner-inner">
      <div>
        <h1 class="page-title">{{ languageService.isFrench() ? 'Événements' : 'Events' }}</h1>
        <p class="page-subtitle">
          {{ languageService.isFrench()
          ? 'Découvrez nos prochains événements et revivez les moments passés.'
          : 'Discover our upcoming events and relive past moments.' }}
        </p>
      </div>
      <div class="page-kpis">
        <div class="kpi-pill">
          <span>{{ languageService.isFrench() ? 'Total' : 'Total' }}</span>
          <strong>{{ totalCount() }}</strong>
        </div>
        <div class="kpi-pill">
          <span>{{ languageService.isFrench() ? 'À venir' : 'Upcoming' }}</span>
          <strong>{{ upcomingCount() }}</strong>
        </div>
      </div>
    </div>
  </section>

  <section class="events-shell">
    <div class="container-custom events-grid">
      <aside class="panel">
        <div class="panel-pad">
          <h3 class="panel-title">{{ languageService.isFrench() ? 'Calendrier' : 'Calendar' }}</h3>
          <div class="panel-actions">
            <button class="icon-btn" (click)="prevMonth()" aria-label="Previous">
              ‹
            </button>
            <div class="cal-nav">{{ monthLabel() }}</div>
            <button class="icon-btn" (click)="nextMonth()" aria-label="Next">
              ›
            </button>
          </div>

          <div class="calendar">
            @for (dow of weekDays(); track dow) {
              <div class="cal-dow">{{ dow }}</div>
            }
            @for (day of calendarDays(); track $index) {
              @if (day) {
                <button class="cal-day"
                        [class.is-today]="isToday(day)"
                        [class.is-selected]="selectedDay() === day"
                        [class.has-event]="hasEventOnDay(day)"
                        (click)="selectDay(day)">
                  {{ day }}
                </button>
              } @else {
                <div class="cal-day is-muted"></div>
              }
            }
          </div>
          @if (selectedDay()) {
            <button class="clear-date" (click)="clearSelectedDay()">
              {{ languageService.isFrench() ? 'Effacer la date' : 'Clear date' }}
            </button>
          }
        </div>

        <div class="panel-pad">
          <h3 class="panel-title">{{ languageService.isFrench() ? 'Filtres rapides' : 'Quick filters' }}</h3>
          <div class="filter-stack">
            <button (click)="filterType.set('all')" class="filter-pill" [class.is-active]="filterType() === 'all'">
              {{ languageService.isFrench() ? 'Tous' : 'All' }}
            </button>
            <button (click)="filterType.set('upcoming')" class="filter-pill" [class.is-active]="filterType() === 'upcoming'">
              {{ languageService.isFrench() ? 'À venir' : 'Upcoming' }}
            </button>
            <button (click)="filterType.set('past')" class="filter-pill" [class.is-active]="filterType() === 'past'">
              {{ languageService.isFrench() ? 'Passés' : 'Past' }}
            </button>
          </div>

          <div class="kpi-stack">
            <div class="kpi">
              <div class="kpi-label">{{ languageService.isFrench() ? 'À venir' : 'Upcoming' }}</div>
              <div class="kpi-value">{{ upcomingCount() }}</div>
              <div class="kpi-sub">{{ languageService.isFrench() ? 'événements programmés' : 'events scheduled' }}</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">{{ languageService.isFrench() ? 'Passés' : 'Past' }}</div>
              <div class="kpi-value">{{ pastCount() }}</div>
              <div class="kpi-sub">{{ languageService.isFrench() ? 'moments à revivre' : 'moments to relive' }}</div>
            </div>
          </div>
        </div>
      </aside>

      <div class="events-right">
        <div class="toolbar">
          <div class="toolbar-title">
            <strong>{{ languageService.isFrench() ? 'Sélection d’événements' : 'Event selection' }}</strong>
            <span>{{ filteredEvents().length }} {{ languageService.isFrench() ? 'résultats' : 'results' }}</span>
          </div>
          <div class="toolbar-controls">
            <input class="search-input"
                   type="text"
                   [value]="searchTerm()"
                   (input)="setSearch($any($event.target).value)"
                   [placeholder]="languageService.isFrench() ? 'Rechercher un événement' : 'Search events'"/>
            <select class="sort-select" [value]="sortOrder()" (change)="setSort($any($event.target).value)">
              <option value="date_desc">
                {{ languageService.isFrench() ? 'Les plus récents' : 'Newest first' }}
              </option>
              <option value="date_asc">
                {{ languageService.isFrench() ? 'Les plus anciens' : 'Oldest first' }}
              </option>
            </select>
          </div>
        </div>

        @if (isLoading()) {
          <div class="loader">
            <div class="spinner"></div>
          </div>
        } @else {
          @if (filteredEvents().length === 0) {
            <div class="empty">
              {{ languageService.isFrench() ? 'Aucun événement trouvé.' : 'No events found.' }}
            </div>
          } @else {
            <div class="events-list">
              @for (event of filteredEvents(); track event.id) {
                <article class="event-row">
                  <div class="event-thumb">
                    @if (event.image_url) {
                      <img [src]="event.image_url" [alt]="event.title_fr">
                    } @else {
                      <div class="event-thumb-fallback">GDG</div>
                    }
                    <div class="event-badge">{{ event.date | date:'dd/MM/yyyy' }}</div>
                  </div>
                  <div class="event-info">
                    <div class="event-top">
                      <span class="event-chip">{{ event.type ? getTypeLabel(event.type) : (languageService.isFrench() ? 'Événement' : 'Event') }}</span>
                      <span class="event-location">{{ event.location || (languageService.isFrench() ? 'Lieu à préciser' : 'Location TBA') }}</span>
                    </div>
                    <h3>{{ languageService.isFrench() ? event.title_fr : event.title_en }}</h3>
                    <p>{{ languageService.isFrench() ? event.description_fr : event.description_en }}</p>
                    <div class="event-meta-row">
                      <span>{{ event.date | date:'dd/MM/yyyy' }} · {{ event.date | date:'HH:mm' }}</span>
                      <span>{{ event.location || (languageService.isFrench() ? 'Lieu à préciser' : 'Location TBA') }}</span>
                      @if (eventLink(event)) {
                        <a [href]="eventLink(event)" target="_blank" rel="noopener">
                          {{ languageService.isFrench() ? 'Lien' : 'Link' }}
                        </a>
                      } @else {
                        <span>{{ languageService.isFrench() ? 'Lien : -' : 'Link: -' }}</span>
                      }
                    </div>
                    <div class="event-actions">
                      <a [routerLink]="['/events', event.id]" class="event-link">
                        {{ languageService.isFrench() ? 'Voir plus' : 'Learn more' }}
                      </a>
                      @if (getEventStatus(event) === 'upcoming') {
                        <button (click)="openParticipation(event)" class="btn-primary event-cta">
                          {{ languageService.isFrench() ? 'Participer' : 'Participate' }}
                        </button>
                      } @else {
                        <span class="event-status">{{ languageService.isFrench() ? 'Terminé' : 'Ended' }}</span>
                      }
                    </div>
                  </div>
                </article>
              }
            </div>
          }
        }
      </div>
    </div>
  </section>

  @if (authService.isProfessionalOrAdmin() || !authService.isAuthenticated()) {
    <section class="events-cta">
      <div class="container-custom events-cta-inner">
        <div>
          <h2>
            @if (authService.isProfessionalOrAdmin()) {
              {{ languageService.isFrench() ? 'Vous avez une idée de sujet ?' : 'Have an idea for a topic?' }}
            } @else {
              {{ languageService.isFrench() ? 'Rejoignez la communauté GDG' : 'Join the GDG community' }}
            }
          </h2>
          <p>
            @if (authService.isProfessionalOrAdmin()) {
              {{ languageService.isFrench()
              ? 'Si vous êtes un professionnel, vous pouvez proposer un sujet pour nos prochains événements.'
              : 'If you are a professional, you can propose a topic for our upcoming events.' }}
            } @else {
              {{ languageService.isFrench()
              ? 'Accédez à nos événements, rencontres et opportunités tech.'
              : 'Get access to our events, meetups and tech opportunities.' }}
            }
          </p>
        </div>
        @if (authService.isProfessionalOrAdmin()) {
          <button (click)="openTopicModal()" class="btn-secondary events-cta-btn">
            {{ languageService.isFrench() ? 'Proposer un sujet' : 'Propose a topic' }}
          </button>
        } @else {
          <button (click)="openJoinModal()" class="btn-secondary events-cta-btn">
            {{ languageService.isFrench() ? 'Nous rejoindre' : 'Join us' }}
          </button>
        }
      </div>
    </section>
  }
</div>

<app-site-footer></app-site-footer>

@if (showParticipationModal() && selectedEvent()) {
  <app-participation-modal
    [eventId]="selectedEvent()!.id"
    [eventTitle]="languageService.isFrench() ? selectedEvent()!.title_fr : selectedEvent()!.title_en"
    (close)="closeParticipation()">
  </app-participation-modal>
}

@if (showTopicModal()) {
  <app-topic-modal (close)="closeTopicModal()"></app-topic-modal>
}

@if (showJoinModal()) {
  <app-join-modal
    (close)="closeJoinModal()">
  </app-join-modal>
}
