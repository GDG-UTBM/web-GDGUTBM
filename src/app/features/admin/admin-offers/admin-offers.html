<div class="p-8">
  <header class="flex flex-wrap justify-between items-center gap-4 mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gdg-text">
        {{ languageService.isFrench() ? 'Gestion des offres' : 'Offers Management' }}
      </h1>
      <p class="text-gdg-muted">
        {{ languageService.isFrench()
          ? 'Créez, modifiez et suivez les candidatures.'
          : 'Create, edit, and track applications.' }}
      </p>
    </div>

    @if (activeTab() === 'offers') {
      <button (click)="openAddModal()" class="btn-primary flex items-center gap-2">
        <span class="text-xl leading-none">+</span>
        {{ languageService.isFrench() ? 'Ajouter' : 'Add' }}
      </button>
    }
  </header>

  <div class="tab-bar">
    <button class="tab" [class.active]="activeTab() === 'offers'" (click)="activeTab.set('offers')">
      {{ languageService.isFrench() ? 'Offres' : 'Offers' }}
      <span class="tab-count">{{ offers().length }}</span>
    </button>
    <button class="tab" [class.active]="activeTab() === 'applications'" (click)="activeTab.set('applications')">
      {{ languageService.isFrench() ? 'Candidatures' : 'Applications' }}
      <span class="tab-count">{{ applications().length }}</span>
    </button>
  </div>

  @if (activeTab() === 'offers') {
    @if (isLoading()) {
      <div class="empty-apps">Chargement des offres...</div>
    }
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mt-6">
      @for (offer of offers(); track offer.id) {
        <article class="bg-gdg-surface rounded-r16 border border-gdg-line overflow-hidden hover:shadow-md transition-shadow flex flex-col">
          <div class="p-5 flex flex-col gap-4 h-full">
            <div class="flex items-center gap-3">
              <div class="logo-box">
                <img [src]="offer.logo" [alt]="offer.company" />
              </div>
              <div>
                <h3 class="font-bold text-lg">{{ offer.title }}</h3>
                <p class="text-sm text-gdg-muted">{{ offer.company }} · {{ offer.location }}</p>
              </div>
            </div>

            <div class="text-sm text-gdg-text/80">
              {{ offer.description }}
            </div>

            <div class="flex flex-wrap gap-2 text-xs text-gdg-muted">
              <span class="pill">{{ offer.type }}</span>
              <span class="pill">{{ offer.duration || '-' }}</span>
              <span class="pill">{{ offer.startDate || '-' }}</span>
              <span class="pill">{{ offer.mode || '-' }}</span>
              <span class="pill">{{ offer.status === 'closed' ? 'Fermée' : 'Ouverte' }}</span>
            </div>

            <div class="mt-auto flex justify-end space-x-3 pt-4 border-t border-gdg-line/50">
              <button (click)="editOffer(offer)" class="text-gdg-blue hover:text-blue-700 font-medium text-sm transition-colors">
                {{ languageService.isFrench() ? 'Modifier' : 'Edit' }}
              </button>
              <button (click)="deleteOffer(offer.id)" class="text-red-600 hover:text-red-800 font-medium text-sm transition-colors">
                {{ languageService.isFrench() ? 'Supprimer' : 'Delete' }}
              </button>
            </div>
          </div>
        </article>
      } @empty {
        <div class="col-span-full text-center py-20 bg-gray-50 rounded-r16 border-2 border-dashed border-gdg-line">
          <p class="text-gdg-muted">
            {{ languageService.isFrench() ? 'Aucune offre pour le moment.' : 'No offers available yet.' }}
          </p>
        </div>
      }
    </div>
  }

  @if (activeTab() === 'applications') {
    @if (isApplicationsLoading()) {
      <div class="empty-apps">Chargement des candidatures...</div>
    }
    <div class="flex flex-wrap items-center justify-between gap-3 mt-6">
      <div class="text-sm text-gdg-muted">
        {{ languageService.isFrench() ? 'Total candidatures :' : 'Total applications:' }} {{ applications().length }}
      </div>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gdg-muted">
          {{ languageService.isFrench() ? 'Filtrer' : 'Filter' }}
        </span>
        <select class="filter-select" [ngModel]="applicationFilter()" (ngModelChange)="applicationFilter.set($event)">
          <option value="all">Toutes</option>
          <option value="pending">En attente</option>
          <option value="approved">Approuvées</option>
          <option value="rejected">Rejetées</option>
        </select>
      </div>
    </div>

    <div class="applications-grid">
      @for (application of applicationsView(); track application.id) {
        <article class="application-card">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-sm text-gdg-muted">{{ offerLabel(application) }}</p>
              <h3 class="font-semibold text-lg">{{ application.full_name }}</h3>
              <p class="text-sm text-gdg-muted">{{ application.email || '-' }}</p>
            </div>
            <span class="status-pill"
                  [class.pending]="application.status === 'pending'"
                  [class.approved]="application.status === 'approved'"
                  [class.rejected]="application.status === 'rejected'">
              {{ statusLabel(application.status) }}
            </span>
          </div>

          <div class="meta-grid">
            <div>
              <span>{{ languageService.isFrench() ? 'Profil' : 'Profile' }}</span>
              <strong>{{ application.role === 'student' ? 'Étudiant' : 'Professionnel' }}</strong>
            </div>
            <div>
              <span>{{ languageService.isFrench() ? 'Date' : 'Date' }}</span>
              <strong>{{ formatDate(application.created_at) }}</strong>
            </div>
            <div>
              <span>{{ languageService.isFrench() ? 'École' : 'School' }}</span>
              <strong>{{ application.school || '-' }}</strong>
            </div>
            <div>
              <span>{{ languageService.isFrench() ? 'Niveau' : 'Level' }}</span>
              <strong>{{ application.study_level || '-' }}</strong>
            </div>
            <div>
              <span>{{ languageService.isFrench() ? 'Profession' : 'Profession' }}</span>
              <strong>{{ application.profession || '-' }}</strong>
            </div>
            <div>
              <span>{{ languageService.isFrench() ? 'Téléphone' : 'Phone' }}</span>
              <strong>{{ application.phone || '-' }}</strong>
            </div>
          </div>

          @if (application.message) {
            <div class="message-box">
              "{{ application.message }}"
            </div>
          }

          <div class="flex justify-end gap-3 pt-4 border-t border-gdg-line/50">
            <button (click)="updateApplicationStatus(application.id, 'approved')"
                    class="btn-secondary">
              {{ languageService.isFrench() ? 'Valider' : 'Approve' }}
            </button>
            <button (click)="updateApplicationStatus(application.id, 'rejected')"
                    class="btn-secondary text-red-600">
              {{ languageService.isFrench() ? 'Refuser' : 'Reject' }}
            </button>
            <button (click)="deleteApplication(application.id)"
                    class="btn-secondary text-gray-500">
              {{ languageService.isFrench() ? 'Supprimer' : 'Delete' }}
            </button>
          </div>
        </article>
      } @empty {
        <div class="empty-apps">
          {{ languageService.isFrench() ? 'Aucune candidature pour le moment.' : 'No applications yet.' }}
        </div>
      }
    </div>
  }

  @if (showModal()) {
    <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4"
         role="dialog"
         aria-modal="true"
         (click)="closeModal()">

      <div class="bg-white rounded-r16 w-full max-w-lg p-6 shadow-2xl animate-scale-in max-h-[90vh] overflow-y-auto"
           (click)="$event.stopPropagation()">

        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold">
            {{ editingId() ? (languageService.isFrench() ? 'Modifier l\'offre' : 'Edit offer') : (languageService.isFrench() ? 'Ajouter une offre' : 'Add offer') }}
          </h3>
          <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>

        <form [formGroup]="offerForm" (ngSubmit)="submitOffer()" class="space-y-4">
          <div class="space-y-1">
            <label class="block text-sm font-semibold text-gdg-text">Titre *</label>
            <input type="text" formControlName="title"
                   class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none transition-all">
          </div>

          <div class="space-y-1">
            <label class="block text-sm font-semibold text-gdg-text">Entreprise *</label>
            <input type="text" formControlName="company"
                   class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none transition-all">
          </div>

          <div class="space-y-1">
            <label class="block text-sm font-semibold text-gdg-text">Localisation *</label>
            <input type="text" formControlName="location"
                   class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none transition-all">
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-1">
              <label class="block text-sm font-semibold text-gdg-text">Type</label>
              <select formControlName="type" class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none">
                <option value="Stage">Stage</option>
                <option value="Alternance">Alternance</option>
                <option value="CDI">CDI</option>
              </select>
            </div>
            <div class="space-y-1">
              <label class="block text-sm font-semibold text-gdg-text">Statut</label>
              <select formControlName="status" class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none">
                <option value="open">Ouverte</option>
                <option value="closed">Fermée</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-1">
              <label class="block text-sm font-semibold text-gdg-text">Durée</label>
              <input type="text" formControlName="duration"
                     class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none">
            </div>
            <div class="space-y-1">
              <label class="block text-sm font-semibold text-gdg-text">Mode</label>
              <input type="text" formControlName="mode"
                     class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none">
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-1">
              <label class="block text-sm font-semibold text-gdg-text">Début (texte)</label>
              <input type="text" formControlName="startDate"
                     class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none"
                     placeholder="Mars 2026">
            </div>
            <div class="space-y-1">
              <label class="block text-sm font-semibold text-gdg-text">Début (date)</label>
              <input type="date" formControlName="start_date"
                     class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none">
            </div>
          </div>

          <div class="space-y-1">
            <label class="block text-sm font-semibold text-gdg-text">Description</label>
            <textarea rows="3" formControlName="description"
                      class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none"></textarea>
          </div>

          <div class="space-y-1">
            <label class="block text-sm font-semibold text-gdg-text">Tags (séparés par des virgules)</label>
            <input type="text" formControlName="tags"
                   class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none">
          </div>

          <div class="space-y-1">
            <label class="block text-sm font-semibold text-gdg-text">Logo (URL)</label>
            <input type="text" formControlName="logo"
                   class="w-full border border-gdg-line rounded-lg px-3 py-2 focus:ring-2 focus:ring-gdg-blue focus:outline-none">
          </div>

          @if (errorMessage()) {
            <div class="p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100">
              {{ errorMessage() }}
            </div>
          }

          <div class="flex justify-end space-x-3 pt-6 border-t border-gdg-line mt-6">
            <button type="button" (click)="closeModal()" class="btn-secondary px-6">
              {{ languageService.isFrench() ? 'Annuler' : 'Cancel' }}
            </button>
            <button type="submit"
                    [disabled]="offerForm.invalid || isSubmitting()"
                    class="btn-primary px-6 disabled:bg-gray-400 disabled:cursor-not-allowed">
              @if (isSubmitting()) {
                <span class="flex items-center gap-2">
                  <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24">
                     <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                     <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  {{ languageService.isFrench() ? 'Enregistrement...' : 'Saving...' }}
                </span>
              } @else {
                {{ languageService.isFrench() ? 'Enregistrer' : 'Save' }}
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
